{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create WishList</title>
    <link rel="stylesheet" href="{% static 'WishStack/css/Main.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-image: url("{% static 'WishStack/images/Gift.png' %}");
        }
    </style>
    <style>
        /* Style for the modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: absolute;
            /* Position it relative to the parent container */
            background-color: #fefefe;
            /* Modal background color */
            border: 1px solid #888;
            /* Modal border */
            padding: 20px;
            /* Modal padding */
            z-index: 1;
            /* Ensure modal stays on top */
        }
    
        /* Style for the close button */
        .close {
            color: #aaa;
            /* Close button color */
            float: right;
            /* Float the button to the right */
            font-size: 28px;
            /* Close button font size */
            font-weight: bold;
            /* Close button font weight */
        
        }
    
        /* Style for the modal content */
        .modal-content {
            display: flex;
            /* Display modal content as a flexbox */
            flex-direction: column;
            /* Arrange modal content in a column */
        }
    
        /* Style for the input field */
        #shareUrlInput {
            margin-bottom: 10px;
            /* Add some space below the input field */
        }

        /* Style for product container */
        #productDetails {
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Style for individual product item */
        .product-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: antiquewhite;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            width: 30%;
            height: 40%;
        }

        /* Style for product title */
        .product-item h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Style for product price and description */
        .product-item p {
            font-size: 1em;
            margin-bottom: 5px;
        }

        /* Style for product image */
        .product-item img {
            max-width: 100%;
            height: 200px;
            width: 200px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        .product-item button {
            margin-left: auto;
        }

        .button-container {
            width: 100%;
            display: flex;
            justify-content: space-around;
        }

        .button-container button {
            margin: 10px;
            padding: 10px 20px;
            background-color: white;
            border-radius: inherit;
            cursor: pointer;
            border: none;
        }

        .delete-button {
            background: none !important;
            color: red;
            font-size: 20px;
        }
        
    </style>
</head>
<body>
    <div class="wrapper">
        <nav class="navbar">
            <ul class="navbar-list">
                <li style="text-align: center;"><a>Birthday Wishlist</a></li>
            </ul>
            <div class="filter-dropdown">
                Filter
                <div class="filter-dropdown-content">
                    <button id="highToLowBtn">High to Low</button>
                    <button id="lowToHighBtn">Low to High</button>
                </div>
            </div>
                <button class="share-button" id="shareButton">Share</button>
            {% if user.is_authenticated %}
                <button class="logout-button" onclick="window.location.href='{% url 'logout' %}'">Logout</button>
            {% endif%}
        </nav>
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>Share this URL:</p>
                <input type="text" id="shareUrlInput" readonly>
                <button id="copyButton">Copy</button>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            {% if user.is_authenticated and user == username  %}
            <button class="amazon-button" onclick="window.location.href='{% url 'scrape_flipkart' %}'"
                data-api-url="{% url 'start_wishing' %}?wishlistName={{ wishlist_name }}">Flipkart</button>
            <button class="amazon-button" onclick="window.location.href='{% url 'scrape_clothing' %}'"
                data-api-url="{% url 'start_wishing' %}?wishlistName={{ wishlist_name }}">Amazon</button>
            {% endif%}
        </div>
    <div id="productDetails">
        <!-- Product details will be populated here -->
    </div>
</div>
<input type="hidden" id="user-username" value="{{ request.user.username }}">
<script src="WishStack/js/Main.js"></script>
<script>
    document.getElementById("shareButton").addEventListener("click", function () {
        // Get the current URL
        var currentUrl = window.location.href;

        // Assuming you have a variable containing the wishlist ID or name
        var wishlistId = "{{ wishlist_id }}"; // Replace "{{ wishlist_id }}" with your actual wishlist ID
        var userName = document.getElementById("user-username").value;
        // Construct the share URL
        var shareUrl = currentUrl + "?wishlist=" + "1/" + "?username=" + userName +"/";

        // Display the modal below the share button
        var modal = document.getElementById("myModal");
        var shareButtonRect = document.getElementById("shareButton").getBoundingClientRect();
        modal.style.top = (shareButtonRect.bottom + window.pageYOffset) + "px";
        modal.style.left = shareButtonRect.left + "px";
        modal.style.display = "block";

        // Populate and copy the URL when "Copy" button is clicked
        var shareUrlInput = document.getElementById("shareUrlInput");
        shareUrlInput.value = shareUrl;

        // Remove any existing event listener to avoid duplication
        var copyButton = document.getElementById("copyButton");
        copyButton.removeEventListener("click", copyUrlToClipboard);

        // Add event listener to copy URL to clipboard
        copyButton.addEventListener("click", copyUrlToClipboard);

        // Close the modal when the close button is clicked
        document.getElementsByClassName("close")[0].addEventListener("click", function () {
            modal.style.display = "none";
        });
    });

    // Function to copy URL to clipboard
    function copyUrlToClipboard() {
        var shareUrlInput = document.getElementById("shareUrlInput");
        shareUrlInput.select();
        document.execCommand("copy");
        alert("URL copied to clipboard");
    }
    var userName = document.getElementById("user-username").value;
    var wishid = 1;
    // Retrieve the JSON string from local storage
    var productData = localStorage.getItem(`${userName}${wishid}WishListItems`);

    // Parse the JSON string into a JavaScript object
    var products = JSON.parse(productData);

    // Create HTML elements to display the product information
    var productDetailsDiv = document.getElementById('productDetails');

    // Iterate over each product object in the array
    products.forEach(function (product) {
        // Create HTML elements for each product
        var productDiv = document.createElement('div');
        productDiv.classList.add('product-item');

        var productImg = document.createElement('img');
        productImg.classList.add('product-img');
        productImg.src = product.image

        var productTitle = document.createElement('h2');
        productTitle.textContent = product.product;

        var productPrice = document.createElement('p');
        productPrice.textContent = 'Price: ' + product.price;

        var productDescription = document.createElement('p');
        productDescription.textContent = 'Description: ' + product.description;

        var buttonDiv = document.createElement('div');
            buttonDiv.classList.add('button-container');

            var buyButton = document.createElement('button')
            buyButton.textContent = "BUY"

            var boughtButton = document.createElement('button')
            boughtButton.textContent = "Bought"

            var wishToBuyButton = document.createElement('button')
            wishToBuyButton.textContent = "Wish to Buy"

            // Create delete button with trash icon
            var deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            var trashIcon = document.createElement('i');
            trashIcon.classList.add('fas', 'fa-trash-alt'); // Font Awesome trash icon
            deleteButton.appendChild(trashIcon);


            // Event listener for the "Bought" button
            boughtButton.addEventListener("click", function () {
                // Disable the "Buy" and "Wish to Buy" buttons
                buyButton.disabled = true;
                wishToBuyButton.style.backgroundColor = "white";
                wishToBuyButton.style.color = "lightgrey";
                wishToBuyButton.disabled = true;
            });

            // Event listener for the "Wish to Buy" button
            wishToBuyButton.addEventListener("click", function () {
                // Change the color of the "Wish to Buy" button when clicked
                wishToBuyButton.style.backgroundColor = "red";
                wishToBuyButton.style.color = "white";
            });

            // Event listener for the "Delete" button
            deleteButton.addEventListener("click", function () {
                console.log("Products", products)
                console.log("Product", product)
                products = products.filter(function (p) {
                    return p.product !== product.product;
                });
                productDiv.remove();
                localStorage.setItem(`${userName}1WishListItems`, JSON.stringify(products))
            });

        // Append the elements to the productDiv
        productDiv.appendChild(productImg);
        productDiv.appendChild(productTitle);
        productDiv.appendChild(productPrice);
        productDiv.appendChild(productDescription);
        buttonDiv.appendChild(buyButton);
        buttonDiv.appendChild(boughtButton);
        buttonDiv.appendChild(wishToBuyButton);
        buttonDiv.appendChild(deleteButton); // Append delete button
        productDiv.appendChild(buttonDiv);

        // Append the productDiv to the container
        productDetailsDiv.appendChild(productDiv);
    });    

    var productData = localStorage.getItem(`${userName}1WishListItems`);
// Parse the JSON string into a JavaScript object
var products = JSON.parse(productData);
console.log(products)

// Function to sort products by price in ascending order
function sortProductsByPriceAscending() {
    console.log("Before sorting:", products);
    products.sort((a, b) => {
        // Remove the currency symbol and commas, then parse as a number
        const priceA = parseFloat(a.price.replace(/[^\d.]/g, ''));
        const priceB = parseFloat(b.price.replace(/[^\d.]/g, ''));
        return priceA - priceB;
    });

    console.log("After sorting:", products);
    updateLocalStorage();
    renderProducts();
}

// Function to sort products by price in descending order
function sortProductsByPriceDescending() {
    console.log("hiiiiiii")
    products.sort((a, b) => {
        const priceA = parseFloat(a.price.replace(/[^\d.]/g, ''));
        const priceB = parseFloat(b.price.replace(/[^\d.]/g, ''));
        return priceB - priceA; // Sort in descending order
    });

    updateLocalStorage();
    renderProducts();
}

// Function to update local storage with sorted data
function updateLocalStorage() {

    console.log("prod......",products)
    localStorage.setItem(`${userName}1WishListItems`, JSON.stringify(products));
    console.log("After updating localStorage:", JSON.parse(localStorage.getItem(`${userName}1WishListItems`)));
}

// Function to render products on the page
function renderProducts() {
    // Clear existing products
    productDetailsDiv.innerHTML = "";

    // Iterate over each product object in the array
    products.forEach(function (product) {
        // Create HTML elements for each product (similar to your existing code)
         // Create HTML elements for each product
         var productDiv = document.createElement('div');
         productDiv.classList.add('product-item');

         var productImg = document.createElement('img');
         productImg.classList.add('product-img');
         productImg.src = product.image

         var productTitle = document.createElement('h2');
         productTitle.textContent = product.product;

         var productPrice = document.createElement('p');
         productPrice.textContent = 'Price: ' + product.price;

         var productDescription = document.createElement('p');
         productDescription.textContent = 'Description: ' + product.description;


         var buttonDiv = document.createElement('div');
         buttonDiv.classList.add('button-container');

         var buyButton = document.createElement('button')
         buyButton.textContent = "BUY"

         var boughtButton = document.createElement('button')
         boughtButton.textContent = "Bought"

         var wishToBuyButton = document.createElement('button')
         wishToBuyButton.textContent = "Wish to Buy"

         // Create delete button with trash icon
         var deleteButton = document.createElement('button');
         deleteButton.classList.add('delete-button');
         var trashIcon = document.createElement('i');
         trashIcon.classList.add('fas', 'fa-trash-alt'); // Font Awesome trash icon
         deleteButton.appendChild(trashIcon);


         // Event listener for the "Bought" button
         boughtButton.addEventListener("click", function () {
             // Disable the "Buy" and "Wish to Buy" buttons
             buyButton.disabled = true;
             wishToBuyButton.style.backgroundColor = "white";
             wishToBuyButton.style.color = "lightgrey";
             wishToBuyButton.disabled = true;
         });

         // Event listener for the "Wish to Buy" button
         wishToBuyButton.addEventListener("click", function () {
             // Change the color of the "Wish to Buy" button when clicked
             wishToBuyButton.style.backgroundColor = "red";
             wishToBuyButton.style.color = "white";
         });

         // Event listener for the "Delete" button
         deleteButton.addEventListener("click", function () {
             console.log("Products", products)
             console.log("Product", product)
             products = products.filter(function (p) {
                 return p.product !== product.product;
             });
             productDiv.remove();
             localStorage.setItem(`${userName}1WishListItems`, JSON.stringify(products))
         });

         // Append the elements to the productDiv
         productDiv.appendChild(productImg);
         productDiv.appendChild(productTitle);
         productDiv.appendChild(productPrice);
         productDiv.appendChild(productDescription);
         buttonDiv.appendChild(buyButton);
         buttonDiv.appendChild(boughtButton);
         buttonDiv.appendChild(wishToBuyButton);
         buttonDiv.appendChild(deleteButton); // Append delete button
         productDiv.appendChild(buttonDiv);

         // Append the productDiv to the container
         productDetailsDiv.appendChild(productDiv);
    });
}

// Event listener for the "High to Low" button
document.getElementById("highToLowBtn").addEventListener("click", sortProductsByPriceDescending);

// Event listener for the "Low to High" button
document.getElementById("lowToHighBtn").addEventListener("click", sortProductsByPriceAscending);

// Initial render of products
//renderProducts();
</script>
</body>
</html>